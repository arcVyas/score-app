html
  head
    title Scorecard - #{title}
    link(rel="icon" href="/icon.png")
    link(rel='stylesheet', href='https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css')
    link(rel="stylesheet" type="text/css" href="https://bootswatch.com/4-alpha/darkly/bootstrap.min.css")
  body
    .container(style="padding-left:25px;padding-right:25px;margin-left:25px;margin-right:25px;width:auto")
      .row.col-sm-12(style="padding-top:20px;padding-bottom:20px;")
        h3 Scorecard for Match -  #{title} 
        span(id="matchId" style="visibility:hidden") #{title}

      .row(style="padding-top:20px;padding-bottom:20px")
        .col-sm-2
          span BALL : 
          h5 
            span(id="currentBall") 
        .col-sm-2
          span SCORE : 
          h5
            span(id="ballTotal")
        .col-sm-2
          span LOG : 
          h5
            span(id="ballLog") 
        .col-sm-6(align="right")
          h1
            span(id="score") #{data.totalScore} / #{data.wickets}

      .row
        .col-sm-12(style="padding-right:20px;")
          .row(style="padding-top:15px; padding-bottom:10px;")
            .col-sm-3
              button.btn.btn-primary.btn-lg.btn-block(id='0') 0
            .col-sm-3
              button.btn.btn-success.btn-lg.btn-block(id='1') 1
            .col-sm-3
              button.btn.btn-success.btn-lg.btn-block(id='2') 2
            .col-sm-3
              button.btn.btn-success.btn-lg.btn-block(id='3') 3
          .row(style="padding-top:15px; padding-bottom:10px;")
            .col-sm-4
              button.btn.btn-success.btn-lg.btn-block(id='4') 4
            .col-sm-4
              button.btn.btn-success.btn-lg.btn-block(id='5') 5
            .col-sm-4
              button.btn.btn-success.btn-lg.btn-block(id='6') 6

          .row(style="padding-top:15px; padding-bottom:10px;")
            .col-sm-4
              button.btn.btn-warning.btn-lg.btn-block(id='WIDE') WIDE
            .col-sm-4
              button.btn.btn-warning.btn-lg.btn-block(id='NOBALL') NO BALL
            .col-sm-4
              button.btn.btn-danger.btn-lg.btn-block(id='OUT') OUT   
        //-
          .col-lg-4(style="border-style:solid;border-color:white; visibility:hidden")
          .row(style="padding-top:15px; padding-bottom:10px;")
            .col-sm-6
              span * Striker
            .col-sm-3
              span 0(0)
            .col-sm-3
              button.btn.btn-primary.btn(id='SSTRIKER') ..
          .row(style="padding-top:15px; padding-bottom:10px;")
            .col-sm-6
              span Non-Striker
            .col-sm-3
              span 0(0)
            .col-sm-3
              button.btn.btn-primary.btn(id='SNSTRIKER') ..
          .row(style="padding-top:15px; padding-bottom:10px;")
            .col.sm-12
                button.btn.btn-primary.btn(id='SWAP') SWAP
                
      .row(style="padding-top:40px;")

        table.table
          thead
            tr
              th Overs
              th x.1
              th x.2
              th x.3
              th x.4
              th x.5
              th x.6
              th Total
              th End Of Over
          tbody
            - var eooScore=0
            each ballsInOver,over in data.overs
              tr
                th(scope='row') 
                  span(id="over_"+over) #{over}
                - var overTotal=0
                each ball in ballsInOver
                  - var ballScore = ball.score;
                  - var ballScoreTxt
                  - if(ballScore==undefined){
                      - ballScoreTxt=" "
                      - ballScore=0
                  -}else{
                      - ballScoreTxt=ballScore
                  -}
                  - overTotal=overTotal+ballScore
                  td 
                    a(id="ball_a_"+ball.ball href="javascript:loadBall("+ball.ball+")" class="btn btn-primary" style="width: 56px;border-color:yellow; border-style:none;")
                      span(id="ball_"+ball.ball style="border-color:yellow;padding-top: 5px;padding-bottom: 5px;padding-left: 5px;padding-right: 5px;") #{ballScoreTxt}
                      span(id="wicket_ball_"+ball.ball style="visibility:hidden") #{ball.wicket}
                td 
                  span(id="overTotal_"+over)
                td 
                  span(id="eooScore_"+over)

      .row.col-sm-12(id="messages")


  script(src='//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js')
  
  script.
    
    var ballInProgress=["WIDE","NOBALL"]
    var validBalls=["0","1","2","3","4","5","6"]
    var lastSelected="0.0"
    var nextPointer="1.1"
    $(document).ready( function () {

      calculateScore()
      loadBall(nextPointer)

      $( "button" ).click(function() {

        var buttonPressed = this.id
        var scoreLog = $("#ballLog").text();
        console.log("Before:"+scoreLog)

        if(!scoreLog.endsWith("+")){
          scoreLog=""+buttonPressed
        }else{
          scoreLog = scoreLog+buttonPressed
        }

        if(ballInProgress.includes(buttonPressed)){
          scoreLog = scoreLog+"+"
        }

        var scoreObj = getScoreObj(scoreLog)
        $("#ballTotal").text(scoreObj.score)
        $("#ballLog").text(scoreObj.scoreLog)
        console.log("After:"+scoreLog)
        saveBall(buttonPressed,$("#currentBall").text(),scoreObj);
      });
    });

    function getScoreObj(scoreLog){
      var entries = scoreLog.split("+")
      var scoreObj={}
      var score=0
      var wicket=false

      for(var i=0;i<entries.length;i++){
        console.log(entries[i])
        if(entries[i]=="OUT"){
          score=score+0
          wicket=true
        }else if(ballInProgress.includes(entries[i])){
          score=score+1
        }else if(validBalls.includes(entries[i])){
          score=score+parseInt(entries[i])
        }
        console.log(score)
      }
      scoreObj["score"]=score
      scoreObj["scoreLog"]=scoreLog
      scoreObj["wicket"]=wicket
      return scoreObj
    }

     function calculateScore(){
        var totalScore=0
        var wickets=0
        var oversComplete="0.0"
        nextPointer=""
        $('[id^="over_"]').each(function(index){
          var over = $(this).text()
          var overTotal=0
          var inCompleteOver=false
          for(var i=1; i<=6; i++){
            var bScore = $("#ball_"+over+"\\."+i).text()
            if(bScore==" "){
              bScore=0
              inCompleteOver=true
              if(nextPointer=="")
                nextPointer=over+"."+i
            }else{
              if(i>=6){
                oversComplete=over
              }else{
                oversComplete=parseInt(over)-1+"."+i
              }
              
              bScore=parseInt(bScore)
            }
            overTotal = overTotal+bScore
            var wicket = $("#wicket_ball_"+over+"\\."+i).text()
            $("#ball_"+over+"\\."+i).css("color",'')
            if(wicket=="true"){
              wickets=wickets+1
              $("#ball_"+over+"\\."+i).css("color","red")
            }
          }
          
          totalScore=totalScore+overTotal
          if(inCompleteOver){
            $("#overTotal_"+over).text("")
            $("#eooScore_"+over).text("")
          }else{
            $("#overTotal_"+over).text(overTotal)
            $("#eooScore_"+over).text(totalScore + "/" + wickets)
          }
          
        })
        var scoreText = totalScore + " / " + wickets + " ( " + oversComplete + " )"
        $("#score").text(scoreText)
      }


    function loadBall(ballId){
      var matchId = $("#matchId").text()
      $.get("/matches/"+matchId+"/scorecard/balls/"+ballId,
      function(scoreCard, status){
          console.log("Data: " + scoreCard + "\nStatus: " + status);
          var data = scoreCard.ballByBall[0]
          if(!data.score)
            data.score=0
          if(!data.scoreLog)
            data.scoreLog=""
          $("#currentBall").text(data.ball)
          $("#ballTotal").text(data.score)
          $("#ballLog").text(data.scoreLog)
          $("#ball_a_"+data.ball.replace(".","\\.")).css("border-style","solid")
          $("#ball_a_"+lastSelected.replace(".","\\.")).css("border-style","none")
          lastSelected=data.ball
      });
      calculateScore()
    }
    function saveBall(scoreButtonPressed,ballId,scoreObj){

      var matchId = $("#matchId").text()
      var score =scoreObj["score"]
      var scoreLog =scoreObj["scoreLog"]
      var wicket =scoreObj["wicket"]

      console.log(matchId+";"+ballId+";"+score+";"+scoreLog)

      $.post("/matches/"+matchId+"/scorecard/balls/"+ballId,
      {
          score: score,
          scoreLog: scoreLog,
          wicket: wicket
      },
      function(data, status){
          console.log("Data: " + data + "\nStatus: " + status);
          $("#ball_"+ballId.replace(".","\\.")).text(score);
          if(wicket){
            $("#wicket_ball_"+ballId.replace(".","\\.")).text("true");
          }else{
            $("#wicket_ball_"+ballId.replace(".","\\.")).text("false");
          }
          calculateScore();
          next(scoreButtonPressed)
      });
      function next(scoreButtonPressed){
        var currentBall = $("#currentBall").text()
        if(!ballInProgress.includes(scoreButtonPressed)){
          $("#ball_"+currentBall.replace(".","\\.")).css("border-style","none")
          var nextBall = getNextBall(currentBall)
          loadBall(nextBall)
        }else{

        }
      }
      function getNextBall(currentBall){
        var over = currentBall.split(".")[0]
        var ball = currentBall.split(".")[1]
        if(ball>=6){
          over = parseInt(over) + 1
          ball = 1
        }else{
          ball= parseInt(ball)+1
        }
        return(over+"."+ball);
      }

      
    }